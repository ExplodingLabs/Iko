begin;

create function api.refresh_token(refresh_token text) returns text
as $$
declare
  access_token text;
  valid bool;
begin
  select exists (
    select 1
    from auth.refresh_token
    where token = refresh_token
    and created_at > current_date - interval '2 minutes'
  ) into valid;

  if not valid then
    raise invalid_refresh_token
    using message = 'Invalid refresh token';
  end if;

  -- Generate a JWT access token, that expires in one hour
  select public.sign(row_to_json(r), current_setting('app.jwt_secret')) as access_token
    from (select _role as role, login.email as email, extract(epoch from now())::integer + 60 * 60 as exp) r into access_token;

  return access_token;

end;
$$
language plpgsql
security definer;

commit;
